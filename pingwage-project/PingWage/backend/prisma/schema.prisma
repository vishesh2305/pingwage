// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // This reads from your .env file
}

generator client {
  provider = "prisma-client-js"
}

// ------------------------------------------
// Enums for type safety
// ------------------------------------------

enum UserRole {
  worker
  employer_admin
  super_admin
}

enum UserStatus {
  active
  suspended
  banned
}

enum AdvanceSpeed {
  instant
  same_day
  next_day
}

enum AdvanceStatus {
  pending
  processing
  completed
  failed
}

enum PaymentProvider {
  stripe
  postfinance
}

enum InvoiceStatus {
  pending
  paid
  overdue
}

// ------------------------------------------
// Database Models
// ------------------------------------------

/// Users (workers + employers + admins)
model User {
  id              String         @id @default(uuid()) @db.Uuid
  phone           String         @unique @db.VarChar(20)
  email           String?        @unique @db.VarChar(255)
  pin_hash        String?        @db.VarChar(255)
  password_hash   String?        @db.VarChar(255)
  role            UserRole       @map("role")
  status          UserStatus     @default(active) @map("status")
  created_at      DateTime       @default(now()) @db.Timestamp
  updated_at      DateTime       @updatedAt @db.Timestamp
  // Relations
  worker_profile  WorkerProfile?
  bank_accounts   BankAccount[]
  notifications   Notification[]
  audit_logs      AuditLog[]
  earnings        Earning[]
  advances        Advance[] // <-- FIX #1: ADDED THIS RELATION

  @@map("users")
}

/// Worker profiles
model WorkerProfile {
  id                  String     @id @default(uuid()) @db.Uuid
  user_id             String     @unique @db.Uuid // A worker profile is tied to one user
  employer_id         String?    @db.Uuid
  first_name          String?    @db.VarChar(100)
  last_name           String?    @db.VarChar(100)
  date_of_birth       DateTime?  @db.Date
  employee_id         String?    @db.VarChar(50)
  department          String?    @db.VarChar(100)
  hourly_rate         Decimal?   @db.Decimal(10, 2)
  profile_photo_url   String?    @db.Text
  created_at          DateTime   @default(now()) @db.Timestamp
  updated_at          DateTime   @updatedAt @db.Timestamp
  // Relations
  user                User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  employer            Employer?  @relation(fields: [employer_id], references: [id])
  // advances         Advance[] // <-- FIX #2: REMOVED THIS FIELD

  @@map("worker_profiles")
}

/// Bank accounts
model BankAccount {
  id           String    @id @default(uuid()) @db.Uuid
  user_id      String    @db.Uuid
  iban         String    @db.VarChar(50)
  bank_name    String?   @db.VarChar(100)
  is_primary   Boolean   @default(false)
  verified     Boolean   @default(false)
  created_at   DateTime  @default(now()) @db.Timestamp
  updated_at   DateTime  @updatedAt @db.Timestamp
  // Relations
  user         User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  advances     Advance[]

  @@map("bank_accounts")
}

/// Employers
model Employer {
  id              String          @id @default(uuid()) @db.Uuid
  company_name    String          @db.VarChar(255)
  email           String          @unique @db.VarChar(255)
  tax_id          String?         @db.VarChar(50)
  logo_url        String?         @db.Text
  settings        Json?           @db.JsonB
  verified        Boolean         @default(false)
  created_at      DateTime        @default(now()) @db.Timestamp
  updated_at      DateTime        @updatedAt @db.Timestamp

  // --- Fields required by controllers ---
  advance_rate          Float           @default(0.5)
  pay_period_frequency  String          @default("weekly")
  pay_period_end_day    String?

  // Relations
  worker_profiles WorkerProfile[]
  earnings        Earning[]
  advances        Advance[]
  invoices        Invoice[]
  payroll_syncs   PayrollSync[]

  @@map("employers")
}

/// Earnings (payroll data)
model Earning {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String   @db.Uuid
  employer_id String   @db.Uuid
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @db.Date
  notes       String?  @db.VarChar(255)
  created_at  DateTime @default(now()) @db.Timestamp

  // Relations
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  employer    Employer @relation(fields: [employer_id], references: [id])

  @@index([user_id])
  @@index([date])
  @@map("earnings")
}

/// Advances (wage withdrawals)
model Advance {
  id               String          @id @default(uuid()) @db.Uuid
  user_id          String          @db.Uuid
  employer_id      String?         @db.Uuid
  amount           Decimal         @db.Decimal(10, 2)
  fee              Decimal         @db.Decimal(10, 2) @default(0)
  total            Decimal         @db.Decimal(10, 2)
  currency         String          @default("CHF") @db.VarChar(3)
  speed            AdvanceSpeed?   @map("speed")
  status           AdvanceStatus   @default(pending) @map("status")
  bank_account_id  String          @db.Uuid
  payment_id       String?         @db.VarChar(255)
  payment_provider PaymentProvider? @map("payment_provider")
  idempotency_key  String?         @unique @db.VarChar(255)
  retry_count      Int             @default(0)
  failure_reason   String?         @db.Text
  created_at       DateTime        @default(now()) @db.Timestamp
  processed_at     DateTime?       @db.Timestamp
  completed_at     DateTime?       @db.Timestamp
  // Relations
  user             User            @relation(fields: [user_id], references: [id], onUpdate: NoAction, onDelete: NoAction)
  employer         Employer?       @relation(fields: [employer_id], references: [id])
  bank_account     BankAccount     @relation(fields: [bank_account_id], references: [id])

  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@map("advances")
}

/// Notifications
model Notification {
  id           String    @id @default(uuid()) @db.Uuid
  user_id      String    @db.Uuid
  type         String    @db.VarChar(50)
  title        String?   @db.VarChar(255)
  message      String?   @db.Text
  read         Boolean   @default(false)
  created_at   DateTime  @default(now()) @db.Timestamp
  // Relations
  user         User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("notifications")
}

/// Invoices (employer billing)
model Invoice {
  id           String        @id @default(uuid()) @db.Uuid
  employer_id  String?       @db.Uuid
  period       String?       @db.VarChar(10)
  amount       Decimal       @db.Decimal(10, 2)
  breakdown    Json?         @db.JsonB
  status       InvoiceStatus @default(pending) @map("status")
  payment_id   String?       @db.VarChar(255)
  paid_at      DateTime?     @db.Timestamp
  due_date     DateTime?     @db.Date
  created_at   DateTime      @default(now()) @db.Timestamp
  // Relations
  employer     Employer?     @relation(fields: [employer_id], references: [id])

  @@map("invoices")
}

/// Audit logs
model AuditLog {
  id            String    @id @default(uuid()) @db.Uuid
  user_id       String?   @db.Uuid
  action        String    @db.VarChar(100)
  entity_type   String?   @db.VarChar(50)
  entity_id     String?   @db.Uuid
  ip_address    String?   @db.VarChar(50)
  user_agent    String?   @db.Text
  created_at    DateTime  @default(now()) @db.Timestamp
  // Relations
  user          User?     @relation(fields: [user_id], references: [id])

  @@map("audit_logs")
}

/// Payroll syncs
model PayrollSync {
  id                  String     @id @default(uuid()) @db.Uuid
  employer_id         String?    @db.Uuid
  status              String     @default("processing") @db.VarChar(20)
  records_processed   Int?
  started_at          DateTime   @default(now()) @db.Timestamp
  completed_at        DateTime?  @db.Timestamp
  // Relations
  employer            Employer?  @relation(fields: [employer_id], references: [id])

  @@map("payroll_syncs")
}


// Model for OTP verification
model VerificationCode {
  id         String   @id @default(uuid()) @db.Uuid
  phone      String   @db.VarChar(20)
  code       String   @db.VarChar(10)
  expires_at DateTime @db.Timestamp
  verified   Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamp

  @@index([phone])
  @@map("verification_codes")
}