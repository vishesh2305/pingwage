// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // This reads from your .env file
}

generator client {
  provider = "prisma-client-js"
}

// ------------------------------------------
// Enums for type safety
// ------------------------------------------

/// From users table [cite: 696-698]
enum UserRole {
  worker
  employer_admin
  super_admin
}

/// From users table [cite: 699-702]
enum UserStatus {
  active
  suspended
  banned
}

/// From advances table [cite: 753-756]
enum AdvanceSpeed {
  instant
  same_day
  next_day
}

/// From advances table [cite: 755-758]
enum AdvanceStatus {
  pending
  processing
  completed
  failed
}

/// From advances table [cite: 759]
enum PaymentProvider {
  stripe
  postfinance
}

/// From invoices table [cite: 788, 768]
enum InvoiceStatus {
  pending
  paid
  overdue
}

// ------------------------------------------
// Database Models
// ------------------------------------------

/// Users (workers + employers + admins) [cite: 690]
model User {
  id              String         @id @default(uuid()) @db.Uuid
  phone           String         @unique @db.VarChar(20)
  email           String?        @unique @db.VarChar(255)
  pin_hash        String?        @db.VarChar(255)
  password_hash   String?        @db.VarChar(255)
  role            UserRole       @map("role") // Maps to the Enum
  status          UserStatus     @default(active) @map("status") // Maps to the Enum
  created_at      DateTime       @default(now()) @db.Timestamp
  updated_at      DateTime       @updatedAt @db.Timestamp
  // Relations
  worker_profile  WorkerProfile? // A user can have one worker profile
  bank_accounts   BankAccount[]
  notifications   Notification[]
  audit_logs      AuditLog[]

  @@map("users")
}

/// Worker profiles [cite: 706]
model WorkerProfile {
  id                  String     @id @default(uuid()) @db.Uuid
  user_id             String     @unique @db.Uuid // A worker profile is tied to one user
  employer_id         String?    @db.Uuid
  first_name          String?    @db.VarChar(100)
  last_name           String?    @db.VarChar(100)
  date_of_birth       DateTime?  @db.Date
  employee_id         String?    @db.VarChar(50)
  department          String?    @db.VarChar(100)
  hourly_rate         Decimal?   @db.Decimal(10, 2)
  profile_photo_url   String?    @db.Text
  created_at          DateTime   @default(now()) @db.Timestamp
  updated_at          DateTime   @updatedAt @db.Timestamp
  // Relations
  user                User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  employer            Employer?  @relation(fields: [employer_id], references: [id])
  earnings            Earning[]
  advances            Advance[]

  @@map("worker_profiles")
}

/// Bank accounts [cite: 718]
model BankAccount {
  id           String    @id @default(uuid()) @db.Uuid
  user_id      String    @db.Uuid
  iban         String    @db.VarChar(50)
  bank_name    String?   @db.VarChar(100)
  is_primary   Boolean   @default(false)
  verified     Boolean   @default(false)
  created_at   DateTime  @default(now()) @db.Timestamp
  updated_at   DateTime  @updatedAt @db.Timestamp
  // Relations
  user         User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  advances     Advance[]

  @@map("bank_accounts")
}

/// Employers [cite: 727]
model Employer {
  id              String          @id @default(uuid()) @db.Uuid
  company_name    String          @db.VarChar(255)
  email           String          @unique @db.VarChar(255)
  tax_id          String?         @db.VarChar(50)
  logo_url        String?         @db.Text
  settings        Json?           @db.JsonB // [cite: 734]
  verified        Boolean         @default(false)
  created_at      DateTime        @default(now()) @db.Timestamp
  updated_at      DateTime        @updatedAt @db.Timestamp
  // Relations
  worker_profiles WorkerProfile[]
  advances        Advance[]
  invoices        Invoice[]
  payroll_syncs   PayrollSync[]

  @@map("employers")
}

/// Earnings (payroll data) [cite: 739]
model Earning {
  id                 String         @id @default(uuid()) @db.Uuid
  worker_id          String?        @db.Uuid
  pay_period_start   DateTime       @db.Date
  pay_period_end     DateTime       @db.Date
  total_earned       Decimal        @db.Decimal(10, 2)
  hours_worked       Decimal?       @db.Decimal(8, 2)
  hourly_rate        Decimal?       @db.Decimal(10, 2)
  updated_at         DateTime       @updatedAt @db.Timestamp
  // Relations
  worker_profile     WorkerProfile? @relation(fields: [worker_id], references: [id])

  @@index([worker_id]) // [cite: 815]
  @@map("earnings")
}

/// Advances (wage withdrawals) [cite: 749]
model Advance {
  id               String          @id @default(uuid()) @db.Uuid
  worker_id        String?         @db.Uuid
  employer_id      String?         @db.Uuid
  amount           Decimal         @db.Decimal(10, 2)
  fee              Decimal         @db.Decimal(10, 2)
  total            Decimal         @db.Decimal(10, 2)
  currency         String          @default("CHF") @db.VarChar(3)
  speed            AdvanceSpeed    @map("speed") // Maps to the Enum
  status           AdvanceStatus   @default(pending) @map("status") // Maps to the Enum
  bank_account_id  String?         @db.Uuid
  payment_id       String?         @db.VarChar(255)
  payment_provider PaymentProvider? @map("payment_provider") // Maps to the Enum
  idempotency_key  String          @unique @db.VarChar(255) // [cite: 760]
  retry_count      Int             @default(0)
  failure_reason   String?         @db.Text
  requested_at     DateTime        @default(now()) @db.Timestamp
  processed_at     DateTime?       @db.Timestamp
  completed_at     DateTime?       @db.Timestamp
  // Relations
  worker_profile   WorkerProfile?  @relation(fields: [worker_id], references: [id])
  employer         Employer?       @relation(fields: [employer_id], references: [id])
  bank_account     BankAccount?    @relation(fields: [bank_account_id], references: [id])

  @@index([worker_id]) // [cite: 814]
  @@index([status]) // [cite: 814]
  @@index([requested_at]) // [cite: 815]
  @@map("advances")
}

/// Notifications [cite: 769]
model Notification {
  id           String    @id @default(uuid()) @db.Uuid
  user_id      String    @db.Uuid
  type         String    @db.VarChar(50)
  title        String?   @db.VarChar(255)
  message      String?   @db.Text
  read         Boolean   @default(false)
  created_at   DateTime  @default(now()) @db.Timestamp
  // Relations
  user         User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id]) // [cite: 816]
  @@map("notifications")
}

/// Invoices (employer billing) [cite: 779]
model Invoice {
  id           String        @id @default(uuid()) @db.Uuid
  employer_id  String?       @db.Uuid
  period       String?       @db.VarChar(10)
  amount       Decimal       @db.Decimal(10, 2)
  breakdown    Json?         @db.JsonB // [cite: 786]
  status       InvoiceStatus @default(pending) @map("status") // Maps to the Enum
  payment_id   String?       @db.VarChar(255)
  paid_at      DateTime?     @db.Timestamp
  due_date     DateTime?     @db.Date
  created_at   DateTime      @default(now()) @db.Timestamp
  // Relations
  employer     Employer?     @relation(fields: [employer_id], references: [id])

  @@map("invoices")
}

/// Audit logs [cite: 795]
model AuditLog {
  id            String    @id @default(uuid()) @db.Uuid
  user_id       String?   @db.Uuid
  action        String    @db.VarChar(100)
  entity_type   String?   @db.VarChar(50)
  entity_id     String?   @db.Uuid
  ip_address    String?   @db.VarChar(50)
  user_agent    String?   @db.Text
  created_at    DateTime  @default(now()) @db.Timestamp
  // Relations
  user          User?     @relation(fields: [user_id], references: [id])

  @@map("audit_logs")
}

/// Payroll syncs [cite: 806]
model PayrollSync {
  id                  String     @id @default(uuid()) @db.Uuid
  employer_id         String?    @db.Uuid
  status              String     @default("processing") @db.VarChar(20)
  records_processed   Int?
  started_at          DateTime   @default(now()) @db.Timestamp
  completed_at        DateTime?  @db.Timestamp
  // Relations
  employer            Employer?  @relation(fields: [employer_id], references: [id])

  @@map("payroll_syncs")
}